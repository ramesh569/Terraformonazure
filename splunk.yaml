receivers:
  filelog/azdo_agent:
    include:
      - /azp/_diag/*.log
    start_at: beginning

    operators:
      - type: multiline
        line_start_pattern: '^\[?\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}Z'

      - type: regex_parser
        regex: '^\[?(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}Z)\s+(?P<severity>INFO|WARN|VERB)\s+(?P<component>[^\]]+)\]\s+(?P<message>.*)$'
        timestamp:
          parse_from: attributes.timestamp
          layout: '%Y-%m-%d %H:%M:%SZ'
        severity:
          parse_from: attributes.severity

      - type: severity_parser
        parse_from: attributes.severity
        mapping:
          VERB: debug
          INFO: info
          WARN: warn

      - type: move
        from: attributes.message
        to: body

processors:
  k8sattributes:
    extract:
      metadata:
        - k8s.pod.name
        - k8s.namespace.name

  resource:
    attributes:
      - key: service.name
        from_attribute: k8s.pod.name
        action: upsert

  batch:

exporters:
  otlp:
    endpoint: splunk-otel-collector.splunk-otel.svc.cluster.local:4317
    tls:
      insecure: true

service:
  pipelines:
    logs:
      receivers: [filelog/azdo_agent]
      processors: [k8sattributes, resource, batch]
      exporters: [otlp]
